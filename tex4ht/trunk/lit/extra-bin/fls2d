#!/usr/bin/env bash
#
# Summary: process *.fls file, output *.d file (Makefile format)
#          with  lists of dependencies and derived files.
#          Second optional param is for removing from deps
#
# Usage: fls2d foo.fls [bar.4ht]
#
# 
# 
set -e
input=$1
stem=${1%.*}
filter=$2 #remove file(s)
doc=./html.dir/${stem}/${stem}.html


awk -v stem=${stem} '
      BEGIN    {
                 auxfiles = stem".""(xref|fls|aux|tmp|4tc|4ct)"
                 begin_with_slash = "^/"
                 htmldir = "./html.dir"
                 print "##\n## Script generated file. Please do not edit\n##"
               }
      END      { print "# derived files list from " stem ".fls." }
      END      { print "define " stem "_derived" }
      END      { for ( j = 1; j < ii+1; j++) print " "outpi[j]"\\" }
      END      { print "\nendef" }
      END      { print "# deps files list from " stem ".fls." }
      END      { print "define " stem "_deps" }
      END      { for ( j = 1; j < i+1; j++) if (inpi[j] in outp) ; else  print " "inpi[j]"\\" }
      END      { print "\nendef" }
      END      { print "# set main html file" }
      END      { print "define " stem "_doc" }
      END      { print " " htmldir "/" stem "/" stem ".html"}
      END      { print "\nendef" }
      $1 == "OUTPUT" && $2 !~ stem && $2 !~ begin_with_slash { outp[$2] = $2; ii++; outpi[ii] = $2 }
      $1 == "INPUT"  &&               $2 !~ begin_with_slash && $2 !~ auxfiles { i++; inpi[i] = $2 }
    ' ${input}


exit
#      END      { for (x in outp) print " "x"\\" }
#      END      { for (x in inp)  print " "x"\\"}
#      END      { for (x in outp) delete inp[x] }

set -e
input=$1
stem=${1%.*}
filter=$2 #remove file(s)
doc=./html.dir/${stem}/${stem}.html

source ${0%/*}/fls2x

echo -e "##\n## Script generated file. Please do not edit\n##"
fls2dd $input $stem ${stem}_derived OUTPUT "derived files list from ${input}."
fls2dd $input $stem ${stem}_deps    INPUT "deps files list from ${input}." $filter
echo -e "\n#set main html file"
echo -e "define ${stem}_doc"
echo -e " ${doc}"
echo -e "endef"

